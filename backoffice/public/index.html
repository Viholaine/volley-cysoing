<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice Volleyball</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .status-success {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üèê Backoffice Volleyball</h1>
            <p class="text-gray-600">Gestion du scraping et des donn√©es FFVB</p>
        </header>

        <!-- Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Carte Scraping -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üï∑Ô∏è Scraping</h2>
                <button id="scrapeBtn" class="w-full bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                    Lancer le scraping
                </button>
                <div id="scrapeStatus" class="mt-4"></div>
            </div>
            
            <!-- Carte Supabase -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üìä Chargement Supabase</h2>
                <button id="loadBtn" class="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors duration-200 font-medium">
                    Charger les donn√©es
                </button>
                <div id="loadStatus" class="mt-4"></div>
            </div>
        </div>

        <!-- Status des donn√©es -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">üìà Statut des donn√©es</h2>
            <button id="statusBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors duration-200 font-medium mb-4">
                Actualiser le statut
            </button>
            <div id="dataStatus" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Statut dynamique -->
            </div>
        </div>

        <!-- Affichage des classements -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">üèÜ Classements</h2>
                <button id="refreshStandingsBtn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors duration-200 text-sm">
                    Actualiser
                </button>
            </div>
            <div id="standingsContainer" class="overflow-x-auto">
                <!-- Classements dynamiques -->
            </div>
        </div>

        <!-- Affichage des matchs -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">üìÖ Matchs</h2>
                <button id="refreshMatchesBtn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors duration-200 text-sm">
                    Actualiser
                </button>
            </div>
            <div id="matchesContainer" class="overflow-x-auto">
                <!-- Matchs dynamiques -->
            </div>
        </div>

        <!-- Logs -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">üìã Logs d'ex√©cution</h2>
                <button id="clearLogsBtn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors duration-200 text-sm">
                    Effacer
                </button>
            </div>
            <div id="logs" class="bg-gray-900 text-green-400 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                <!-- Logs dynamiques -->
            </div>
        </div>
    </div>

    <script>
        // √âl√©ments DOM
        const scrapeBtn = document.getElementById('scrapeBtn');
        const loadBtn = document.getElementById('loadBtn');
        const statusBtn = document.getElementById('statusBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const scrapeStatus = document.getElementById('scrapeStatus');
        const loadStatus = document.getElementById('loadStatus');
        const dataStatus = document.getElementById('dataStatus');
        const logs = document.getElementById('logs');

        // Fonctions utilitaires
        function setButtonLoading(button, loading) {
            if (loading) {
                button.disabled = true;
                button.classList.add('btn-loading');
                button.innerHTML = 'En cours...';
            } else {
                button.disabled = false;
                button.classList.remove('btn-loading');
                // Restaurer le texte original
                if (button.id === 'scrapeBtn') {
                    button.innerHTML = 'Lancer le scraping';
                } else if (button.id === 'loadBtn') {
                    button.innerHTML = 'Charger les donn√©es';
                }
            }
        }

        function showStatus(element, message, type) {
            const alertClass = type === 'success' 
                ? 'bg-green-100 border-green-400 text-green-700' 
                : type === 'error'
                ? 'bg-red-100 border-red-400 text-red-700'
                : 'bg-blue-100 border-blue-400 text-blue-700';
            
            element.innerHTML = `
                <div class="border-l-4 p-4 rounded ${alertClass} status-success">
                    <p class="font-medium">${message}</p>
                </div>
            `;
            
            // Auto-disparition apr√®s 5 secondes
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry mb-1';
            
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // Fonctions pour afficher les donn√©es
        async function displayStandings() {
            try {
                const response = await fetch('/api/standings');
                const standings = await response.json();
                
                let html = '';
                if (standings.length === 0) {
                    html = '<p class="text-gray-500 text-center py-4">Aucun classement disponible</p>';
                } else {
                    html = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√âquipe</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Points</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jou√©s</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">V/D</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sets</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ratio</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    standings.forEach(standing => {
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${standing.rank}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${standing.team_name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${standing.points}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${standing.played}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${standing.wins}/${standing.losses}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${standing.sets_won}/${standing.sets_lost}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${standing.ratio}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                document.getElementById('standingsContainer').innerHTML = html;
            } catch (error) {
                addLog(`Erreur affichage classements: ${error.message}`, 'error');
                document.getElementById('standingsContainer').innerHTML = '<p class="text-red-500 text-center py-4">Erreur lors du chargement des classements</p>';
            }
        }

        async function displayMatches() {
            try {
                const response = await fetch('/api/matches');
                const matches = await response.json();
                
                let html = '';
                if (matches.length === 0) {
                    html = '<p class="text-gray-500 text-center py-4">Aucun match disponible</p>';
                } else {
                    html = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heure</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Domicile</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ext√©rieur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lieu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    matches.forEach(match => {
                        const statusClass = match.status === 'completed' ? 'text-green-600' : 'text-yellow-600';
                        const statusText = match.status === 'completed' ? 'Termin√©' : '√Ä venir';
                        
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${match.date || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${match.time || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${match.home_team}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${match.away_team}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${match.home_sets !== null && match.away_sets !== null ? 
                                        `${match.home_sets} - ${match.away_sets}` : '-'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${match.venue || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                document.getElementById('matchesContainer').innerHTML = html;
            } catch (error) {
                addLog(`Erreur affichage matchs: ${error.message}`, 'error');
                document.getElementById('matchesContainer').innerHTML = '<p class="text-red-500 text-center py-4">Erreur lors du chargement des matchs</p>';
            }
        }

        // Fonctions API
        async function scrapeData() {
            setButtonLoading(scrapeBtn, true);
            addLog('D√©but du scraping...', 'info');
            
            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(scrapeStatus, 'Scraping termin√© avec succ√®s!', 'success');
                    addLog('Scraping termin√© avec succ√®s', 'success');
                    await updateDataStatus();
                } else {
                    showStatus(scrapeStatus, `Erreur: ${result.message}`, 'error');
                    addLog(`Erreur de scraping: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(scrapeStatus, `Erreur r√©seau: ${error.message}`, 'error');
                addLog(`Erreur r√©seau: ${error.message}`, 'error');
            } finally {
                setButtonLoading(scrapeBtn, false);
            }
        }

        async function loadToSupabase() {
            setButtonLoading(loadBtn, true);
            addLog('D√©but du chargement dans Supabase...', 'info');
            
            try {
                const response = await fetch('/api/load-to-supabase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(loadStatus, 'Chargement termin√© avec succ√®s!', 'success');
                    addLog('Chargement dans Supabase termin√© avec succ√®s', 'success');
                } else {
                    showStatus(loadStatus, `Erreur: ${result.message}`, 'error');
                    addLog(`Erreur de chargement: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(loadStatus, `Erreur r√©seau: ${error.message}`, 'error');
                addLog(`Erreur r√©seau: ${error.message}`, 'error');
            } finally {
                setButtonLoading(loadBtn, false);
            }
        }

        async function updateDataStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                let html = '';
                
                // Teams
                const teamsStatus = status.teams || {};
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">üë• √âquipes</h3>
                        <p class="text-sm ${teamsStatus.exists ? 'text-green-600' : 'text-red-600'}">
                            ${teamsStatus.exists ? '‚úÖ Existe' : '‚ùå Manquant'} 
                            ${teamsStatus.size ? `(${teamsStatus.size} √©l√©ments)` : ''}
                        </p>
                    </div>
                `;
                
                // Matches
                const matchesStatus = status.matches || {};
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">üìÖ Matchs</h3>
                        <p class="text-sm ${matchesStatus.exists ? 'text-green-600' : 'text-red-600'}">
                            ${matchesStatus.exists ? '‚úÖ Existe' : '‚ùå Manquant'} 
                            ${matchesStatus.size ? `(${matchesStatus.size} √©l√©ments)` : ''}
                        </p>
                    </div>
                `;
                
                // Standings
                const standingsStatus = status.standings || {};
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">üèÜ Classements</h3>
                        <p class="text-sm ${standingsStatus.exists ? 'text-green-600' : 'text-red-600'}">
                            ${standingsStatus.exists ? '‚úÖ Existe' : '‚ùå Manquant'} 
                            ${standingsStatus.size ? `(${standingsStatus.size} √©l√©ments)` : ''}
                        </p>
                    </div>
                `;
                
                dataStatus.innerHTML = html;
                
            } catch (error) {
                addLog(`Erreur mise √† jour statut: ${error.message}`, 'error');
            }
        }

        async function clearLogs() {
            try {
                await fetch('/api/logs', { method: 'DELETE' });
                logs.innerHTML = '';
                addLog('Logs effac√©s', 'info');
            } catch (error) {
                addLog(`Erreur effacement logs: ${error.message}`, 'error');
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const logsData = await response.json();
                
                logs.innerHTML = '';
                logsData.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry mb-1';
                    
                    const timestamp = new Date(log.timestamp).toLocaleTimeString();
                    const colorClass = log.type === 'error' ? 'text-red-400' : log.type === 'success' ? 'text-green-400' : 'text-blue-400';
                    
                    logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="${colorClass}">${log.message}</span>`;
                    
                    logs.appendChild(logEntry);
                });
                
                if (logsData.length > 0) {
                    logs.scrollTop = logs.scrollHeight;
                }
            } catch (error) {
                addLog(`Erreur chargement logs: ${error.message}`, 'error');
            }
        }

        // √âcouteurs d'√©v√©nements
        scrapeBtn.addEventListener('click', scrapeData);
        loadBtn.addEventListener('click', loadToSupabase);
        statusBtn.addEventListener('click', updateDataStatus);
        clearLogsBtn.addEventListener('click', clearLogs);
        
        // Nouveaux boutons pour rafra√Æchir les donn√©es
        document.getElementById('refreshStandingsBtn').addEventListener('click', displayStandings);
        document.getElementById('refreshMatchesBtn').addEventListener('click', displayMatches);

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            updateDataStatus();
            loadLogs();
            displayStandings();
            displayMatches();
            
            // Rafra√Æchir les logs toutes les 5 secondes
            setInterval(loadLogs, 5000);
        });
    </script>
</body>
</html>